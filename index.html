<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FSS 게시판 모니터</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #ffffff;
        color: #1d1d1f;
        line-height: 1.5;
      }

      .container {
        max-width: 980px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 48px;
      }
      .header h1 {
        font-size: 48px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
        letter-spacing: -0.03em;
      }
      .header .stats {
        color: #86868b;
        font-size: 19px;
        font-weight: 400;
      }

      .controls {
        margin-bottom: 32px;
      }

      .search-box {
        width: 100%;
        padding: 16px 20px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 17px;
        background: #ffffff;
      }
      .search-box:focus {
        outline: none;
        border-color: #007aff;
      }

      .filter-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .filter-btn {
        padding: 12px 24px;
        border: 1px solid #d2d2d7;
        background: #ffffff;
        border-radius: 12px;
        cursor: pointer;
        font-size: 17px;
        font-weight: 400;
        color: #1d1d1f;
      }
      .filter-btn.active {
        background: #1d1d1f;
        color: white;
        border-color: #1d1d1f;
      }

      .posts-container {
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        overflow: hidden;
      }

      .post-item {
        border-bottom: 1px solid #d2d2d7;
        padding: 24px;
        background: #ffffff;
      }
      .post-item:last-child {
        border-bottom: none;
      }
      .post-item.new {
        background: #f5f5f7;
      }

      .post-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        line-height: 1.3;
      }
      .post-title a {
        color: #1d1d1f;
        text-decoration: none;
      }
      .post-title a:hover {
        color: #007aff;
      }

      .post-meta {
        font-size: 15px;
        color: #86868b;
        margin-bottom: 16px;
      }

      .post-files {
        margin-top: 16px;
      }
      .file-item {
        display: block;
        margin-bottom: 8px;
      }
      .file-link {
        color: #007aff;
        text-decoration: none;
        font-size: 17px;
        font-weight: 400;
      }
      .file-link:hover {
        text-decoration: underline;
      }

      .loading,
      .error {
        text-align: center;
        padding: 48px;
        font-size: 17px;
        color: #86868b;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }
        .header h1 {
          font-size: 32px;
        }
        .header .stats {
          font-size: 17px;
        }
        .filter-buttons {
          flex-wrap: wrap;
          justify-content: center;
        }
        .post-item {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🏛️ FSS 게시판 모니터</h1>
        <div class="stats">
          <span id="total-posts">게시글 로딩 중...</span> |
          <span id="last-update">업데이트 확인 중...</span>
        </div>
      </div>

      <div class="controls">
        <input
          type="text"
          id="search"
          class="search-box"
          placeholder="제목이나 내용에서 검색..."
        />
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">전체</button>
          <button class="filter-btn" data-filter="new">신규</button>
          <button class="filter-btn" data-filter="files">첨부파일</button>
          <button class="filter-btn" data-filter="today">오늘</button>
        </div>
      </div>

      <div class="posts-container">
        <div class="loading" id="loading">데이터를 불러오는 중...</div>
        <div id="posts-list"></div>
        <div class="error" id="error" style="display: none"></div>
      </div>
    </div>

    <script>
      let allPosts = [];
      let allFiles = [];
      let currentFilter = 'all';

      // 유틸리티 함수들
      function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const icons = {
          pdf: '📄',
          hwp: '📝',
          doc: '📝',
          docx: '📝',
          xls: '📊',
          xlsx: '📊',
          ppt: '📈',
          pptx: '📈',
          zip: '🗜️',
          rar: '🗜️',
          txt: '📃',
        };
        return icons[ext] || '📎';
      }

      function getFileType(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        return ext.toUpperCase();
      }

      async function loadData() {
        try {
          console.log('데이터 로딩 시작...');

          const [postsResponse, filesResponse] = await Promise.all([
            fetch('data/posts.json').catch(() => ({ json: () => [] })),
            fetch('data/files.json').catch(() => ({ json: () => [] })),
          ]);

          allPosts = await postsResponse.json();
          allFiles = await filesResponse.json();

          console.log(
            `로드된 게시글: ${allPosts.length}개, 파일: ${allFiles.length}개`
          );

          updateStats();
          displayPosts();

          document.getElementById('loading').style.display = 'none';
        } catch (error) {
          console.error('데이터 로드 오류:', error);
          showError(`데이터를 불러올 수 없습니다: ${error.message}`);
        }
      }

      function updateStats() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const newPostsCount = allPosts.filter(
          (post) => post.crawled_at && post.crawled_at.startsWith(today)
        ).length;

        const totalFiles = allFiles.length;

        document.getElementById(
          'total-posts'
        ).textContent = `총 ${allPosts.length}개 게시글 (오늘 ${newPostsCount}개 신규) • 첨부파일 ${totalFiles}개`;

        // 최근 크롤링 시간 계산
        let lastCrawlTime = '처음 실행';
        if (allPosts.length > 0) {
          const latestPost = allPosts.reduce((latest, post) =>
            new Date(post.crawled_at) > new Date(latest.crawled_at)
              ? post
              : latest
          );
          lastCrawlTime = new Date(latestPost.crawled_at).toLocaleString(
            'ko-KR'
          );
        }

        document.getElementById(
          'last-update'
        ).textContent = `최종 크롤링: ${lastCrawlTime}`;
      }

      function displayPosts() {
        const searchTerm = document
          .getElementById('search')
          .value.toLowerCase();
        let filteredPosts = filterPosts(allPosts, currentFilter, searchTerm);

        // 최신순 정렬 (게시글 ID 기준)
        filteredPosts.sort((a, b) => {
          const idA = parseInt(a.id) || 0;
          const idB = parseInt(b.id) || 0;
          return idB - idA; // 큰 ID가 먼저 (최신순)
        });

        if (filteredPosts.length === 0) {
          document.getElementById('posts-list').innerHTML =
            '<div style="padding: 40px; text-align: center; color: #666;">😅 검색 결과가 없습니다.</div>';
          return;
        }

        const postsHtml = filteredPosts
          .map((post) => {
            const postFiles = allFiles.filter(
              (file) => file.post_id === post.id
            );
            const isNew = isPostNew(post);

            return `
                    <div class="post-item ${isNew ? 'new' : ''}">
                        <div class="post-title">
                            ${
                              post.url
                                ? `<a href="${post.url}" target="_blank">${post.title}</a>`
                                : `<span>${post.title}</span>`
                            }
                            ${
                              isNew
                                ? '<span style="color: #007bff; font-size: 12px; margin-left: 8px;">🆕 NEW</span>'
                                : ''
                            }
                        </div>
                        <div class="post-meta">
                            <span>📅 ${post.date_posted || '날짜 미상'}</span>
                            ${
                              post.author
                                ? `<span>👤 ${post.author}</span>`
                                : ''
                            }
                            <span>👁️ ${post.views || '0'}</span>
                            <span>🆔 ${post.id}</span>
                        </div>
                        ${
                          postFiles.length > 0
                            ? `
                            <div class="post-files">
                                📎 첨부파일 (${postFiles.length}개):
                                ${postFiles
                                  .map((file) => {
                                    const icon = getFileIcon(file.file_name);
                                    const fileType = getFileType(
                                      file.file_name
                                    );
                                    const shortName =
                                      file.file_name.length > 25
                                        ? file.file_name.substring(0, 25) +
                                          '...'
                                        : file.file_name;

                                    return `
                                        <span class="file-item">
                                            <a href="${file.file_url}" class="file-link" target="_blank"
                                               title="[${fileType}] ${file.file_name}">
                                                ${icon} ${shortName} <span class="file-type">[${fileType}]</span>
                                            </a>
                                        </span>
                                    `;
                                  })
                                  .join('')}
                            </div>
                        `
                            : '<div style="color: #999; font-size: 12px; margin-top: 5px;">📎 첨부파일 없음</div>'
                        }
                    </div>
                `;
          })
          .join('');

        document.getElementById('posts-list').innerHTML = postsHtml;
      }

      function filterPosts(posts, filter, searchTerm) {
        let filtered = posts;

        // 검색어 필터링
        if (searchTerm) {
          filtered = filtered.filter(
            (post) =>
              post.title.toLowerCase().includes(searchTerm) ||
              (post.author && post.author.toLowerCase().includes(searchTerm))
          );
        }

        // 카테고리 필터링
        switch (filter) {
          case 'new':
            filtered = filtered.filter((post) => isPostNew(post));
            break;
          case 'files':
            const postsWithFiles = new Set(
              allFiles.map((file) => file.post_id)
            );
            filtered = filtered.filter((post) => postsWithFiles.has(post.id));
            break;
          case 'today':
            const today = new Date().toISOString().split('T')[0];
            filtered = filtered.filter(
              (post) =>
                post.date_posted &&
                post.date_posted.includes(today.replace(/-/g, '.'))
            );
            break;
        }

        return filtered;
      }

      function isPostNew(post) {
        if (!post.crawled_at) return false;
        const crawledDate = new Date(post.crawled_at);
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        return crawledDate > oneDayAgo;
      }

      function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
      }

      // 이벤트 리스너 설정
      document.addEventListener('DOMContentLoaded', function () {
        document
          .getElementById('search')
          .addEventListener('input', displayPosts);

        document.querySelectorAll('.filter-btn').forEach((btn) => {
          btn.addEventListener('click', (e) => {
            document
              .querySelectorAll('.filter-btn')
              .forEach((b) => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.filter;
            displayPosts();
          });
        });

        // 페이지 로드 시 데이터 불러오기
        loadData();

        // 5분마다 데이터 새로고침
        setInterval(loadData, 5 * 60 * 1000);
      });
    </script>
  </body>
</html>
